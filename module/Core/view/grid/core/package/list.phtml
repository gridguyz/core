<?php
/**
 * @var $this \Zend\View\Renderer\PhpRenderer
 */
$this->headTitle( $title = $this->translate(
    'admin.navTop.packages',
    'admin'
) );

$paginator = $this->paginator;

$paginator->setPageRange( 7 )
          ->setItemCountPerPage( 5 )
          ->setCurrentPageNumber( $this->page );

$this->headLink()
     ->appendStylesheet( '/styles/packages.css' );

if ( empty( $this->filter['category'] ) )
{
    $this->filter['category'] = '';
}

if ( empty( $this->filter['contains'] ) )
{
    $this->filter['contains'] = '';
}

if ( ! isset( $this->filter['installed'] ) || '' === $this->filter['installed'] )
{
    $this->filter['installed'] = null;
}

?>
<h1><?= $title ?></h1>
<div class="page">
    <form class="package-list-form" action="?">
        <p class="package-list-actions">
            <a href="/app/<?= $this->locale() ?>/admin/package/update"
               class="update-all button-appearance"><?= $this->translate( 'admin.packages.action.updateAll', 'admin' ) ?></a>
        </p>
        <p class="package-list-categories">
            <input name="filter[category]" value="<?= $this->filter['category'] ?>" />
            <button name="filter[category]" type="submit"
                    value=""<?php if ( '' == $this->filter['category'] ):
                 ?> class="active"<?php endif ?>>
                <?= $this->translate( 'admin.packages.category.all', 'admin' ) ?>
            </button>
<?php foreach ( $this->categories as $category ): ?>

            <button name="filter[category]" type="submit"
                    value="<?= $category ?>"<?php if ( $category == $this->filter['category'] ):
                 ?> class="active"<?php endif ?>>
                <?= $this->translate( 'admin.packages.category.' . $category, 'admin' ) ?>
            </button>
<?php endforeach ?>

        </p>
        <p class="package-list-search">
            <label>
                <input type="radio" name="filter[installed]" value=""<?php if ( null === $this->filter['installed'] ):
                    ?> checked="checked"<?php endif ?>/>
                <?= $this->translate( 'admin.packages.installed.all', 'admin' ) ?>
            </label>
            <label>
                <input type="radio" name="filter[installed]" value="1"<?php if ( $this->filter['installed'] ):
                    ?> checked="checked"<?php endif ?>/>
                <?= $this->translate( 'admin.packages.installed.only', 'admin' ) ?>
            </label>
            <label>
                <input type="radio" name="filter[installed]" value="0"<?php if ( null !== $this->filter['installed'] && ! $this->filter['installed'] ):
                    ?> checked="checked"<?php endif ?>/>
                <?= $this->translate( 'admin.packages.installed.not', 'admin' ) ?>
            </label>
            <label>
                <?= $this->translate( 'admin.packages.contains', 'admin' ) ?>
                <input type="search" name="filter[contains]" value="<?= $this->escapeHtmlAttr( $this->filter['contains'] ) ?>" />
            </label>
            <button type="submit">
                <?= $this->translate( 'admin.packages.search', 'admin' ) ?>
            </button>
        </p>
        <?= $paginationControl = $this->paginationControl(
            $paginator,
            'Sliding',
            'paginator/default'
        ) ?>

        <div class="package-list">
<?php if ( ! $paginator->getTotalItemCount() ): ?>

            <div class="warn package-list-empty">
                <?= $this->translate( 'default.rowSet.noData' ) ?>
            </div>
<?php else: ?>

<?php foreach ( $paginator as $name => $package ): ?>
<?php if ( $package && $package->isValid() ): ?>

            <div class="package-entry">
                <img class="icon" src="/images/common/blank.gif"
<?php if ( $package->displayIcon ): ?>

                     style="background-image: url(<?= $this->escapeHtmlAttr( $package->displayIcon ) ?>);"
<?php endif ?>

                     alt="<?= $this->escapeHtmlAttr( $name ) ?>"/>
                <div class="name">
<?php if ( $package->canInstall() ): ?>

                    <a href="/app/<?= $this->locale() ?>/admin/package/install/<?= $package->urlSafeName ?>"
                       class="action install button-appearance"><?= $this->translate( 'admin.packages.action.install', 'admin' ) ?></a>
<?php elseif ( $package->canRemove() ): ?>

                    <a href="/app/<?= $this->locale() ?>/admin/package/remove/<?= $package->urlSafeName ?>"
                       class="action remove button-appearance"><?= $this->translate( 'admin.packages.action.remove', 'admin' ) ?></a>
<?php endif ?>

                    <a href="/app/<?= $this->locale() ?>/admin/package/view/<?= $package->urlSafeName ?>"
                       class="name-link"><?= $this->escapeHtml( $package->displayedName ) ?></a>
                </div>
                <div class="description">
                    <?= nl2br( $this->escapeHtml( $package->displayedDescription ) ) ?>

                    <a href="/app/<?= $this->locale() ?>/admin/package/view/<?= $package->urlSafeName ?>"
                       class="action view button-appearance"><?= $this->translate( 'admin.packages.action.view', 'admin' ) ?></a>
                </div>
            </div>
<?php else: ?>

            <div class="warn package-entry-invalid">
                <!-- invalid package: "<?= $name ?>" -->
            </div>
<?php endif ?>
<?php endforeach ?>
<?php endif ?>

        </div>

        <?= $paginationControl ?>

    </form>
</div>
